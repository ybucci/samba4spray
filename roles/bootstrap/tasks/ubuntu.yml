---

- name: Ubuntu | Install pip3
  apt:
    name: python3-pip
    state: present
    update_cache: yes
  when: ubuntu.fastest_apt is defined
  async: 1000
  poll: 0
  register: apt_pip_sleeper

- name: 'Ubuntu | Waiting pip3 installation'
  async_status:
    jid: "{{ apt_pip_sleeper.ansible_job_id }}"
  register: job_result
  until: job_result.finished
  retries: 50
  delay: 10
  when: ubuntu.fastest_apt is defined

- name: Ubuntu | Install Apt-Select
  pip:
    name: apt-select
  when: ubuntu.fastest_apt is defined

- name: Ubuntu | Remove old generated sources.list on user home folder
  file:
    path: /home/{{ ansible_ssh_user }}/sources.list
    state: absent
  when: ubuntu.fastest_apt is defined
  ignore_errors: yes

- name: Ubuntu | Select APT fatest mirror
  shell: apt-select --country BR
  when: ubuntu.fastest_apt is defined
  retries: 5
  delay: 5
  register: result
  until: result.rc == 0

- name: Ubuntu | Set APT fatest mirror
  shell: cat /home/{{ ansible_ssh_user }}/sources.list > /etc/apt/sources.list
  when: ubuntu.fastest_apt is defined

- name: Ubuntu | Upgrade all packages to the latest version
  apt:
    name: "*"
    state: latest
    update_cache: yes
  async: 1000
  poll: 0
  register: apt_sleeper

- name: 'Ubuntu | Waiting Upgrade All Packages'
  async_status:
    jid: "{{ apt_sleeper.ansible_job_id }}"
  register: job_result
  until: job_result.finished
  retries: 100
  delay: 10

- name: Ubuntu | Install Required Packages
  apt:
    name:
      - acl
      - apt-utils
      - attr
      - autoconf
      - bind9utils
      - binutils
      - bison
      - build-essential
      - ccache
      - chrpath
      - curl
      - debhelper
      - dnsutils
      - docbook-xml
      - docbook-xsl
      - flex
      - gcc
      - gdb
      - git
      - glusterfs-common
      - gzip
      - heimdal-multidev
      - hostname
      - htop
      - krb5-config
      - krb5-kdc
      - krb5-user
      - language-pack-en
      - lcov
      - libacl1-dev
      - libarchive-dev
      - libattr1-dev
      - libavahi-common-dev
      - libblkid-dev
      - libbsd-dev
      - libcap-dev
      - libcephfs-dev
      - libcups2-dev
      - libdbus-1-dev
      - libglib2.0-dev
      - libgnutls28-dev
      - libgpgme11-dev
      - libicu-dev
      - libjansson-dev
      - libjs-jquery
      - libjson-perl
      - libkrb5-dev
      - libldap2-dev
      - liblmdb-dev
      - libncurses5-dev
      - libpam0g-dev
      - libparse-yapp-perl
      - libpcap-dev
      - libpopt-dev
      - libreadline-dev
      - libsystemd-dev
      - libtasn1-bin
      - libtasn1-dev
      - libtracker-sparql-2.0-dev
      - libunwind-dev
      - lmdb-utils
      - locales
      - lsb-release
      - make
      - mawk
      - mingw-w64
      - patch
      - perl
      - perl-modules
      - pkg-config
      - procps
      - psmisc
      - python3
      - python3-cryptography
      - python3-dbg
      - python3-dev
      - python3-dnspython
      - python3-gpg
      - python3-iso8601
      - python3-markdown
      - python3-matplotlib
      - python3-pexpect
      - python3-pyasn1
      - python3-setproctitle
      - rng-tools
      - rsync
      - sed
      - sudo
      - tar
      - tree
      - uuid-dev
      - wget
      - xfslibs-dev
      - xsltproc
      - zlib1g-dev
      - resolvconf
      - net-tools
      - traceroute
      - unzip
      - ntp
    state: present
    update_cache: yes
  async: 1000
  poll: 0
  register: apt_sleeper

- name: 'Ubuntu | Waiting Install all Packages'
  async_status:
    jid: "{{ apt_sleeper.ansible_job_id }}"
  register: job_result
  until: job_result.finished
  retries: 100
  delay: 10

- name: Ubuntu | Install Bind9
  apt:
    name:
      - bind9
  when: dns_backend == "bind9"

- name: Post-Install | Enable service Bind9
  systemd:
    name: bind9
    enabled: yes
  when: dns_backend == "bind9"

- name: Post-Install | Enable service Resolvconf
  systemd:
    name: resolvconf.service
    enabled: yes
  when: '''ID=ubuntu'' in os_release.stdout_lines'